<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Shopping List - Tests</title>
  <style>
    body { font-family: system-ui, sans-serif; padding: 16px; }
    .pass { color: #0a0; }
    .fail { color: #c00; }
    #results { margin-top: 12px; }
    #results > div { margin: 4px 0; }
  </style>
  <script src="../script.js" defer></script>
</head>
<body>
  <h1>Test Runner</h1>
  <div id="results"></div>
  <div id="listGrid"></div>
  <div id="totalAmount"></div>

  <script defer>
  (function(){
    function logResult(name, passed, msg){
      const div = document.createElement('div');
      div.className = passed ? 'pass' : 'fail';
      div.textContent = (passed ? 'PASS' : 'FAIL') + ': ' + name + (msg ? ' - ' + msg : '');
      document.getElementById('results').appendChild(div);
      if (!passed) console.error('Test failed:', name, msg || '');
    }
    function assertEqual(name, actual, expected){
      const passed = (actual === expected);
      logResult(name, passed, 'expected ' + JSON.stringify(expected) + ' got ' + JSON.stringify(actual));
    }

    try {
      // levenshtein sanity
      assertEqual('levenshtein kitten->sitting is 3', levenshtein('kitten','sitting'), 3);

      // normalizeName final-letter mapping: ך -> כ
      assertEqual('normalizeName final-letter mapping', normalizeName('מלך'), 'מלכ');

      // getPriceForItem prefers manual over API
      localStorage.setItem('manualPrices', JSON.stringify({'לחם':'5.5'}));
      localStorage.setItem('apiPrices', JSON.stringify({'לחם':'6'}));
      assertEqual('getPriceForItem prefers manual', getPriceForItem('לחם'), '5.5');

      // computeTotalFromDOM should use price * quantity
      const grid = document.getElementById('listGrid');
      grid.innerHTML = '';
      const item = document.createElement('div');
      item.className = 'item';
      item.innerHTML = '<span class="qty"><span class="q-amount">2</span><span class="q-unit">יח&#39;</span></span>'+
                       '<span class="price"><span class="currency">₪</span><span class="amount">3.5</span></span>';
      grid.appendChild(item);
      renderTotal();
      assertEqual('computeTotalFromDOM uses qty', document.getElementById('totalAmount').textContent, '7 ₪');

      logResult('All tests executed', true);
    } catch (e) {
      logResult('Unexpected error', false, (e && e.message) || String(e));
    }
  })();
  </script>
</body>
</html>
